---
title: 【体系】--select语句在Oracle实例中的运作过程
date: 2019-10-14 
categories: Oracle
tags: Oracle体系
---



#### 问题重点：考察执行计划方面知识



#### SQL中Select语句的执行顺序：

1. from子句组装不同数据源的数据；
2. where子句基于指定的条件对记录行进行筛选；
3. group by子句将数据分组；
4. 使用聚集函数进行计算；
5. 使用having子句筛选分组；
6. 计算所有的表达式；
7. 使用order by对结果集进行排序。



#### SQL中Select语句的执行效率：  

1. ##### Oracle语句提高查询效率的方法
>where column in(...);--效率低
>where exists (...);--效率高

在Oracle中可以几乎将所有的IN操作符子查询改写为使用EXISTS的子查询
使用EXISTS，Oracle系统会首先检查主查询，然后运行子查询直到它找到第一个匹配项节省了时间  
Oracle系统在执行IN子查询时，首先执行子查询并将获得的结果列表存放在一个加了索引的临时表中

2. ##### Oracle优化器提高效率的方法

  选择最有效率的表名顺序(Oracle 10g以前基于规则的优化器），即从右到左的顺序处理FROM子句中的表名，最后的表为驱动表最先处理。  
  FROM子句后为多表时，应以记录条数最少的表作为基础表。  
  ORACLE处理多个表时，运用排序及合并的方式连接多个表

- 首先，扫描第一个驱动表并对记录进行排序，
- 其次，扫描第二个表
- 最后将部分第二个表数据和部分驱动表数据进行合并。
  - 3个以上的表连接查询需选择交叉表，即：连接以后的表为基础表再进行操作。



#### SQL中Select语句在实例中的执行过程：

ORACLE中SQL语句由<font>用户进程</font>产生后，传到相对应的<font>服务端进程</font>之后由服务器进程执行该SQL语句。  
SELECT语句中，<font color="red">服务器进程</font>还需要将执行结果回传给<font color="red">用户进程</font>。

- SQL语句的执行步骤：
  - 解析（PARSE）
  - 绑定（BIND）
  - 执行（EXECUTE）
  - 提取（FETCH 只有SELECT才需要这步）


1. ##### 解析

服务器进程接收SQL语句时，11g版本中基于COB优化器（依据统计信息生成执行计划），生成执行计划。
首先在shared pool中查看是否存在解析相同的SQL语句后所存储的<font color="red">SQL文本</font>、<font color="red">解析树</font>和<font color="red">执行计划</font>。  

 * 软解析
 如果shared pool中存在已经生成的执行计划，直接在library cache中击中执行计划，跳到绑定或执行阶段，此过程称为软解析。

 * 硬解析
 如果shared pool中无可供使用的已经生成的执行计划，便需要解析SQL语句生成执行计划，此过程称为硬解析。


语法检查（library cache中）：检查SQL语句语法是否符合规范，检查表达式是否有意义等。

语义解析（library cache中）：检查SQL语句是否有意义。如：检查SQL中所需数据库对象是否存在，且用户拥有操作权限。

视图转换和表达式转换
转换对视图的查询语句为相应的对基表查询；
转换复杂表达式为等效连接。

决定最佳执行计划。不同版本的优化器会生成多个执行计划，11g中按统计信息带入，找出执行成本最小的计划作为执行计划。

library cache中存放SQL文本、解析树、执行计划，以及存放地址、SQL语句的哈希值等信息。

2. ##### 绑定

如果SQL语句使用了绑定变量，扫描绑定变量的声明并赋值，将变量值带入执行计划。

3. ##### 执行

此阶段按照生成的执行计划执行SQL，产生执行结果。

SELECT查询
查看database buffer cache中是否存在结果集

- 存在，进行逻辑读及直接在database buffer cache中拿到数据  
- 不存在，进行物理读需要server process将数据从硬盘I/O进database buffer cache中，再进行逻辑读。

4. ##### 提取  

提取是select语句仅有的步骤，在PGA中提取必要的对结果集进行筛选，在交给用户进程。